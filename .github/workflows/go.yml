name: OneForAll for subdomain, port scan and Upload Results

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  scan-and-upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v4

      - name: Install dependencies
        run: |
          
          sudo apt install gobuster
          
      - name: Run easy_gobuster
        run: |
          go install github.com/OJ/gobuster/v3@latest
          gobuster -h
          # å®šä¹‰åŸºç¡€é…ç½®
          URL_FILE="./url.txt"
          GOBUSTER_MODE="dir"
          WORDLIST="./dic.txt"
          OUTPUT_DIR="gobuster_results"

          # æ£€æŸ¥url.txtæ˜¯å¦å­˜åœ¨
          if [ ! -f "$URL_FILE" ]; then
              echo "é”™è¯¯ï¼š$URL_FILE æ–‡ä»¶ä¸å­˜åœ¨ï¼"
              exit 1
          fi
          # åˆ›å»ºç»“æœä¿å­˜ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          mkdir -p "$OUTPUT_DIR"
          # é€è¡Œè¯»å–URLæ–‡ä»¶
          LINE_NUM=0
          while IFS= read -r URL; do
              # è·³è¿‡ç©ºè¡Œå’Œä»¥#å¼€å¤´çš„æ³¨é‡Šè¡Œ
              if [[ -z "$URL" || "$URL" =~ ^# ]]; then
                  continue
              fi
              LINE_NUM=$((LINE_NUM + 1))
              echo "========================================"
              echo "å¼€å§‹å¤„ç†ç¬¬ $LINE_NUM ä¸ªURL: $URL"
              echo "========================================"

              # ç”Ÿæˆå®‰å…¨çš„æ–‡ä»¶åï¼ˆæ›¿æ¢URLä¸­çš„ç‰¹æ®Šå­—ç¬¦ï¼‰
              SAFE_URL=$(echo "$URL" | sed -e 's/[^a-zA-Z0-9]/_/g')
              OUTPUT_FILE="${OUTPUT_DIR}/${SAFE_URL}_gobuster.txt"
              mkdir OUTPUT_FILE
              ls -alh
              # è¿è¡Œgobusterå¹¶ä¿å­˜ç»“æœ
              # æ ¸å¿ƒå‘½ä»¤ï¼šå¯æ ¹æ®éœ€è¦è°ƒæ•´gobusterå‚æ•°ï¼ˆå¦‚è¶…æ—¶ã€çº¿ç¨‹æ•°ç­‰ï¼‰
              gobuster "$GOBUSTER_MODE" \
                  -u "$URL" \
                  -w "$WORDLIST" \
                  -o "$OUTPUT_FILE" \
                  -t 10 \          # çº¿ç¨‹æ•°ï¼Œå¯æ ¹æ®æœåŠ¡å™¨æ€§èƒ½è°ƒæ•´
                  --timeout 10s    # è¶…æ—¶æ—¶é—´

              # æ£€æŸ¥gobusteræ‰§è¡Œæ˜¯å¦æˆåŠŸ
              if [ $? -eq 0 ]; then
                  echo "âœ… ç¬¬ $LINE_NUM ä¸ªURLå¤„ç†å®Œæˆï¼Œç»“æœä¿å­˜è‡³: $OUTPUT_FILE"
              else
                  echo "âŒ ç¬¬ $LINE_NUM ä¸ªURLå¤„ç†å¤±è´¥ï¼"
                  # è®°å½•å¤±è´¥çš„URLåˆ°é”™è¯¯æ–‡ä»¶
                  echo "$URL" >> "${OUTPUT_DIR}/failed_urls.txt"
              fi

              echo -e "\n"  # ç©ºè¡Œåˆ†éš”ä¸åŒURLçš„è¾“å‡º

          done < "$URL_FILE"

          # æœ€ç»ˆç»Ÿè®¡
          echo "========================================"
          echo "ğŸ“Š æ‰€æœ‰URLå¤„ç†å®Œæˆï¼"
          echo "âœ… æˆåŠŸå¤„ç†: $LINE_NUM ä¸ªURL"
          echo "ğŸ“ ç»“æœç›®å½•: $OUTPUT_DIR"
          if [ -f "${OUTPUT_DIR}/failed_urls.txt" ]; then
              FAILED_COUNT=$(wc -l < "${OUTPUT_DIR}/failed_urls.txt")
              echo "âŒ å¤±è´¥æ•°é‡: $FAILED_COUNT ä¸ªï¼ˆè¯¦è§ failed_urls.txtï¼‰"
          fi
          echo "========================================"
          ls -alh
      - name: Compress easy_gobuster directory
        run: |
          cd ..
          ls -alh
          tar -czvf easy_gobuster.tar.gz easy_gobuster
          ls -alh
          
      - name: Upload compressed easy_gobuster
        uses: actions/upload-artifact@v4
        with:
          name: easy_gobuster
          path: easy_gobuster.tar.gz
          if-no-files-found: error
          retention-days: 7
          compression-level: 6
          overwrite: false
          include-hidden-files: false
    
